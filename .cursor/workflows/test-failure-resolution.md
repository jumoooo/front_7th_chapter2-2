# 테스트 실패 해결 워크플로우

## 📋 개요

이 워크플로우는 사용자가 테스트 실패 문제를 보고할 때 AI 에이전트가 따라야 하는 단계별 프로세스를 정의합니다.

## 🎯 사용 예시

```
@basic.mini-react.test.tsx (81-314) 에서 지금 toEqual에서 안된다고 나오는데
현재 구현은 @elements.ts (1-92) 이렇게 해놨어
왜 안되는지 알려주고 해결해줘
다만 테스트코드는 건들면 안되고 @elements.ts (1-92) 부분만 수정해줘
```

## 🔄 워크플로우 단계

### 1단계: 문제 이해 (Problem Understanding)

**목표**: 테스트와 구현 코드를 읽고 문제 상황을 파악합니다.

**작업 내용**:

- [ ] 테스트 파일의 지정된 라인 범위 읽기
  - `@filename.test.tsx (start-end)` 형식으로 제공된 범위
  - 테스트 케이스와 기대값(expect) 확인
  - `it.each` 같은 매개변수화된 테스트의 경우 모든 케이스 확인
- [ ] 구현 파일의 지정된 라인 범위 읽기
  - `@filename.ts (start-end)` 형식으로 제공된 범위
  - 현재 구현 로직 확인
  - 관련 함수와 변수 파악
- [ ] 주변 맥락 읽기 (필요한 경우)
  - 타입 정의 확인
  - 사용되는 유틸리티 함수 확인
  - 상수나 설정값 확인

**출력물**:

- 테스트에서 기대하는 동작 요약
- 현재 구현의 실제 동작 요약
- 기대값과 실제값의 차이점 식별

---

### 2단계: 문제 진단 (Problem Diagnosis)

**목표**: 왜 테스트가 실패하는지 근본 원인을 찾습니다.

**작업 내용**:

- [ ] 기대값 vs 실제값 비교
  - 테스트의 `expected` 객체 구조 확인
  - 실제 구현이 반환하는 구조 확인
  - 구조적 차이점 식별 (타입, 키, 값 등)
- [ ] 코드 실행 흐름 추적
  - 함수 호출 순서 확인
  - 조건문 분기 확인
  - 반환값 생성 과정 확인
- [ ] 엣지 케이스 확인
  - null/undefined 처리 여부
  - 빈 배열/객체 처리 여부
  - 중첩 구조 처리 여부
  - 타입 변환 처리 여부
- [ ] 일반적인 문제 패턴 확인
  - 정규화(normalization) 문제
  - 배열 평탄화(flattening) 문제
  - 키(key) 추출/제거 문제
  - 자식(children) 구조화 문제

**출력물**:

- 문제의 근본 원인 설명
- 어떤 부분이 잘못되었는지 구체적 지적
- 수정이 필요한 로직 식별

---

### 3단계: 해결책 구현 (Solution Implementation)

**목표**: 구현 파일만 수정하여 테스트를 통과시킵니다.

**작업 내용**:

- [ ] 수정 범위 확인
  - 사용자가 지정한 파일만 수정
  - 사용자가 지정한 라인 범위 내에서 수정 (가능한 경우)
  - 테스트 파일은 절대 수정하지 않음
- [ ] 코드 수정
  - 근본 원인에 맞는 수정 적용
  - 기존 코드 패턴과 스타일 유지
  - 모든 테스트 케이스를 처리하는 수정 (한 케이스만이 아닌)
  - 적절한 에러 처리 및 엣지 케이스 추가
- [ ] 코드 품질 확인
  - 타입 안전성 유지
  - 기존 컨벤션 준수
  - 불필요한 변경 없음

**출력물**:

- 수정된 코드
- 수정 사항에 대한 설명
- 왜 이 수정이 문제를 해결하는지 설명

---

### 4단계: 검증 (Verification)

**목표**: 수정이 올바르게 작동하는지 확인합니다.

**작업 내용**:

- [ ] 테스트 실행
  - `pnpm test:basic` 또는 `pnpm test` 실행
  - 실패했던 테스트가 통과하는지 확인
- [ ] 회귀 테스트
  - 다른 테스트가 깨지지 않았는지 확인
  - 관련된 모든 테스트 케이스 확인
- [ ] 최종 확인
  - 코드 스타일 확인
  - 타입 체크 통과 확인
  - 린터 오류 없음 확인

**출력물**:

- 테스트 실행 결과
- 통과/실패 상태
- 추가로 확인이 필요한 사항 (있는 경우)

---

## 📝 체크리스트

### 필수 준수 사항

- [ ] 테스트 파일은 절대 수정하지 않음
- [ ] 사용자가 지정한 파일만 수정
- [ ] 사용자가 지정한 라인 범위 내에서 수정 (가능한 경우)
- [ ] 기존 코드 패턴과 스타일 유지
- [ ] 모든 관련 테스트 케이스 처리
- [ ] 타입 안전성 유지

### 수정 시 고려사항

- [ ] null/undefined 처리
- [ ] 빈 배열/객체 처리
- [ ] 중첩 구조 처리
- [ ] 타입 변환 처리
- [ ] 배열 평탄화 처리
- [ ] 키 추출 및 제거 처리
- [ ] VNode 구조 정확성

---

## 🎯 일반적인 문제 패턴

### 1. 정규화 문제

**증상**: null, undefined, boolean 값이 필터링되지 않음

**확인 사항**:

- `isEmptyValue` 함수 사용 여부
- boolean 타입 체크 여부
- 필터링 로직 위치

### 2. 배열 처리 문제

**증상**: 중첩 배열이 평탄화되지 않음

**확인 사항**:

- `flat()` 사용 여부
- 재귀적 처리 여부
- 빈 배열 필터링 여부

### 3. 구조 문제

**증상**: VNode 구조가 테스트 기대와 다름

**확인 사항**:

- `type`, `key`, `props` 구조 정확성
- `children` 배열 구조
- `nodeValue` 위치 (TEXT_ELEMENT의 경우)

### 4. 타입 변환 문제

**증상**: 원시 타입이 TEXT_ELEMENT로 변환되지 않음

**확인 사항**:

- string/number → TEXT_ELEMENT 변환
- `createTextElement` 함수 사용
- `nodeValue` 값 설정

---

## 💡 팁

1. **테스트를 명세서로 사용**: 테스트가 기대하는 것이 정답입니다
2. **한 번에 하나씩**: 여러 문제가 있으면 하나씩 해결
3. **패턴 확인**: 비슷한 테스트 케이스들을 함께 보면 패턴을 파악할 수 있습니다
4. **최소 변경**: 문제를 해결하는 데 필요한 최소한의 변경만 수행

---

## 📚 관련 규칙

이 워크플로우는 다음 규칙 파일들과 연계됩니다:

- `.cursor/rules/problem-solving-workflow.mdc` - 문제 해결 상세 규칙
- `.cursor/rules/test-driven-development.mdc` - 테스트 기반 개발 규칙
- `.cursor/rules/file-reference-scope.mdc` - 파일 참조 및 범위 규칙
- `.cursor/rules/code-style.mdc` - 코드 스타일 규칙
- `.cursor/rules/error-handling.mdc` - 에러 처리 규칙
