# Reconciliation Logic Flaw Analysis and Fix

## 1. 문제 상황

이전 이벤트 핸들러 등록 문제 해결 후에도 아래와 같은 기능들이 여전히 동작하지 않음:
-   E2E 테스트에서 검색창 입력 오류 발생
-   무한 스크롤 기능 미작동
-   헤더의 카트 버튼 클릭 시 모달창이 뜨지 않음

이는 상태 변경 후 UI가 올바르게 업데이트되지 않는, 즉 리렌더링 과정에 더 깊은 문제가 있음을 시사합니다.

## 2. 원인 분석 (`codebase_investigator` 결과)

`codebase_investigator`를 통해 분석한 결과, 문제의 핵심은 `packages/react/src/core/reconciler.ts`의 **함수형 컴포넌트(Function Component) 재조정 로직**에 있었습니다.

전체 업데이트 흐름은 다음과 같습니다.
1.  **이벤트 발생 및 상태 업데이트**: `useState`의 setter가 호출되면 상태가 변경되고, `enqueueRender`가 정상적으로 호출되어 렌더링을 스케줄링합니다. (정상)
2.  **렌더링 시작**: `render` 함수가 `reconcile` 함수를 호출하여 루트부터 재조정을 시작합니다. (정상)
3.  **재조정 로직 (문제 발생)**:
    -   `reconcile` 함수가 업데이트할 노드 타입이 `function`인 경우(즉, 함수형 컴포넌트일 때) 로직에 결함이 있습니다.
    -   **현재 로직**: 함수형 컴포넌트를 **먼저 실행**(`renderFunctionComponent`)하여 새로운 자식 VNode를 얻고, 이 VNode를 이전 인스턴스와 재조정하려고 시도합니다.
    -   **문제점**: 이 방식은 부모가 리렌더링되어도 자식 컴포넌트의 함수 자체를 다시 실행하는 과정을 건너뛰게 만듭니다. 재조정기는 '컴포넌트'가 아닌, 컴포넌트가 반환한 'DOM 엘리먼트 VNode'를 비교하게 되므로, props가 바뀌지 않는 한 아무런 변화가 없다고 판단하여 자식 컴포넌트의 업데이트를 생략합니다.

## 3. 근본 원인

**`reconcile` 함수가 함수형 컴포넌트를 처리할 때, 컴포넌트 함수를 다시 실행하고 그 결과를 이전 자식 인스턴스와 비교하는 대신, 잘못된 순서로 로직을 처리하여 하위 컴포넌트 트리의 업데이트를 누락시키는 것**이 근본 원인입니다.

## 4. 해결 방안 제안

`packages/react/src/core/reconciler.ts`의 `reconcile` 함수 내 `if (typeof nextNode.type === 'function')` 블록의 로직을 수정합니다.

새로운 로직은 다음과 같은 순서로 동작해야 합니다.
1.  기존 인스턴스와 타입이 같은지 확인합니다. (`instance?.type === nextNode.type`)
2.  만약 타입이 같다면, 해당 컴포넌트의 **이전 자식 인스턴스(`instance.children[0]`)**와 컴포넌트를 **새롭게 렌더링한 결과(`renderFunctionComponent(nextNode, instance, path)`)**를 재귀적으로 `reconcile` 해야 합니다.
3.  타입이 다르다면, 완전히 새로운 컴포넌트이므로 새롭게 렌더링하고 DOM에 삽입합니다.

이 수정을 통해 부모의 상태 변경이 자식 컴포넌트의 재실행 및 연쇄적인 리렌더링으로 올바르게 이어지게 할 수 있습니다.

---

## 5. 2차 분석: 런타임 오류 지속

### 문제 상황

-   `reconciler.ts` 수정 후 `pnpm test`는 모두 통과했습니다.
-   하지만 `pnpm run dev`로 앱을 실행하면 여전히 기능이 동작하지 않습니다.

### 새로운 가설

단위 테스트 환경(JSDOM 등)과 실제 브라우저 런타임 환경의 차이로 인해 발생하는 문제로 추정됩니다. 특히, 재조정 로직이 실제 애플리케이션의 복잡한 **중첩 컴포넌트 구조**를 만났을 때, **자식에게 전달할 부모 DOM(`parentDom`)을 잘못 추적**하고 있을 가능성이 높습니다.

-   **가설**: 함수형 컴포넌트는 자체 DOM이 없습니다. 따라서 그 자식 컴포넌트를 재조정할 때, 부모로부터 `parentDom`을 올바르게 물려받아야 합니다. 현재 로직은 이 `parentDom`을 전달하는 과정에 결함이 있어, 메모리상에서는 VDOM이 올바르게 생성되지만 실제 DOM 트리에는 삽입/반영되지 못하는 것입니다.

### 다음 단계

1.  수정된 `reconciler.ts`의 함수 컴포넌트 재조정 로직을 다시 검토하여 `parentDom` 전달 과정을 집중적으로 분석합니다.
2.  실제 앱의 컴포넌트 구조(`HomePage.jsx`)를 확인하여 가설을 검증합니다.